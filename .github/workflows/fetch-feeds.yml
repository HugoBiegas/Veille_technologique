name: ðŸ”„ Fetch RSS Feeds

on:
  # ExÃ©cution automatique toutes les 3 heures
  schedule:
    - cron: '0 */3 * * *'
  
  # Permet l'exÃ©cution manuelle depuis l'interface GitHub
  workflow_dispatch:
  
  # ExÃ©cution Ã  chaque push sur main (pour tester)
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'feeds/**'
      - '.github/workflows/**'

# Permissions nÃ©cessaires pour commit et push
permissions:
  contents: write

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout du repository
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Setup Python
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. Installation des dÃ©pendances
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. ExÃ©cution du script de fetch
      - name: ðŸ” Fetch RSS feeds
        run: |
          python scripts/fetch-feeds.py
        continue-on-error: false
      
      # 5. VÃ©rification des changements
      - name: ðŸ“Š Check for changes
        id: check_changes
        run: |
          if git diff --quiet data/; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes detected"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected in data/"
          fi
      
      # 6. Commit et push des changements
      - name: ðŸ’¾ Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add les fichiers JSON modifiÃ©s
          git add data/*.json
          
          # Commit avec un message horodatÃ©
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
          git commit -m "ðŸ”„ Update feeds: $TIMESTAMP

          Automated update via GitHub Actions
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}"
          
          # Push vers main
          git push
      
      # 7. Summary du job
      - name: ðŸ“ Job summary
        if: always()
        run: |
          echo "## ðŸ“° Tech Veille RSS Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "âœ… **Status:** Feeds updated successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  **Status:** No new articles found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Updated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– AI News: \`data/ai_news.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security News: \`data/security_news.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’» Dev News: \`data/dev_news.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’° Finance News: \`data/finance_news.json\`" >> $GITHUB_STEP_SUMMARY
      
      # 8. Notification en cas d'Ã©chec (optionnel)
      - name: âš ï¸ Notify on failure
        if: failure()
        run: |
          echo "âŒ Workflow failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY

  # Job optionnel : Deploy sur GitHub Pages
  deploy-pages:
    needs: fetch-and-update
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ðŸš€ Deploy info
        run: |
          echo "## ðŸš€ GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Site will be automatically deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ github.repository_owner }}.github.io/tech-veille/" >> $GITHUB_STEP_SUMMARY